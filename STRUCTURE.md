# هيكل مشروع MedLab - نظام إدارة المختبرات الطبية

هذا المستند يشرح هيكل مشروع MedLab بشكل مفصل، موضحًا دور كل مجلد وملف في النظام.

## نظرة عامة

MedLab هو نظام إدارة مختبر طبي متكامل مبني باستخدام Next.js وPrisma وMySQL. يوفر النظام مجموعة شاملة من الوظائف لإدارة المرضى والفحوصات والعينات والفواتير والتقارير.

## التقنيات المستخدمة

المشروع يعتمد على مجموعة من التقنيات الحديثة:

- **Next.js 15**: إطار عمل React للتطوير الشامل (Full-stack)
- **React 19**: مكتبة JavaScript لبناء واجهات المستخدم
- **TypeScript**: لغة برمجة تضيف الأنواع الثابتة إلى JavaScript
- **Prisma 6**: ORM للتعامل مع قواعد البيانات
- **TailwindCSS 4**: إطار عمل CSS لتصميم واجهات المستخدم
- **JWT**: للمصادقة وإدارة الجلسات
- **Bcrypt**: لتشفير كلمات المرور
- **React Hot Toast**: للإشعارات
- **Lucide React**: لأيقونات التطبيق
- **Framer Motion**: لإضافة حركات وانتقالات سلسة
- **Zustand**: لإدارة حالة التطبيق

### `/package.json`

يحتوي على تكوين المشروع وقائمة التبعيات المستخدمة:

```json
{
  "name": "medlab",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "tailwind:init": "tailwindcss init -p"
  },
  "dependencies": {
    "@headlessui/react": "^2.2.2",
    "@nextui-org/react": "^2.6.11",
    "@prisma/client": "^6.7.0",
    "@radix-ui/react-dialog": "^1.1.11",
    "@radix-ui/react-slot": "^1.2.0",
    "@radix-ui/react-tabs": "^1.1.9",
    "bcryptjs": "^3.0.2",
    "jose": "^6.0.10",
    "js-cookie": "^3.0.5",
    "jsonwebtoken": "^9.0.2",
    "lucide-react": "^0.503.0",
    "next": "15.3.1",
    "react": "^19.0.0",
    "react-dom": "^19.0.0",
    "react-hot-toast": "^2.5.2",
    "react-pdf": "^9.2.1",
    "zustand": "^5.0.3"
    // ... المزيد من التبعيات
  }
}
```

## أدوار المستخدمين وصلاحياتهم

يدعم النظام أربعة أدوار رئيسية، كل منها له صلاحيات محددة:

### 1. المسؤول (ADMIN)

- له وصول كامل لجميع وظائف النظام
- يمكنه إدارة المستخدمين (إنشاء، تحديث، حذف)
- يمكنه الوصول إلى جميع التقارير والإحصائيات
- يمكنه تكوين إعدادات النظام

### 2. موظف الاستقبال (RECEPTIONIST)

- إدارة المرضى (إنشاء، تحديث، عرض)
- إدارة قائمة الانتظار
- تعيين الفحوصات للمرضى
- إنشاء الفواتير
- عرض تقارير محدودة

### 3. فني المختبر (LAB_TECHNICIAN)

- إدارة الفحوصات (تحديث حالة، إدخال نتائج)
- إدارة العينات (تسجيل، تحديث)
- عرض معلومات المرضى المرتبطة بالفحوصات
- عرض وإنشاء تقارير الفحوصات

### 4. المحاسب (ACCOUNTANT)

- إدارة الفواتير (عرض، تحديث)
- تسجيل المدفوعات
- إنشاء التقارير المالية
- عرض معلومات المرضى المرتبطة بالفواتير

## أمان النظام

### نظام المصادقة والتفويض

- **JWT (JSON Web Tokens)**: يُستخدم للمصادقة وإنشاء جلسات المستخدمين
- **تشفير كلمات المرور**: يتم تشفير كلمات المرور باستخدام Bcrypt قبل تخزينها في قاعدة البيانات
- **Middleware للحماية**: يتحقق من صلاحية الجلسة ويوجه المستخدمين بناء على أدوارهم
- **تخزين آمن للبيانات**: تخزين البيانات الحساسة بشكل آمن

### صلاحيات الوصول المستندة إلى الأدوار

- لكل مسار في التطبيق، يتم التحقق من دور المستخدم وما إذا كان لديه الصلاحية للوصول إليه
- تنفيذ قائمة تحكم الوصول (ACL) في `middleware.ts`
- واجهات مستخدم مخصصة تظهر فقط الخيارات المناسبة لكل دور

### أمان البيانات

- التحقق من صحة البيانات للمدخلات
- عزل البيانات حسب الدور (لا يمكن لمستخدم الوصول إلى بيانات لا يحتاج إليها)
- تسجيل الأنشطة المهمة للمساءلة

## سير العمل في النظام

### 1. عملية المصادقة

1. **تسجيل الدخول**:

   - يدخل المستخدم بريده الإلكتروني وكلمة المرور في صفحة تسجيل الدخول (`/auth/login`)
   - يتم إرسال طلب POST إلى نقطة النهاية `/api/auth/login`
   - يتم التحقق من صحة بيانات الاعتماد
   - في حالة نجاح المصادقة، يتم إنشاء رمز JWT وإرجاعه مع معلومات المستخدم
   - يتم تخزين الرمز في كوكيز المتصفح وفي التخزين المحلي للتأمين المزدوج

2. **التحقق من الجلسة**:

   - يتحقق ملف `middleware.ts` من وجود رمز المصادقة في كل طلب
   - يقوم بتوجيه المستخدمين غير المصادقين إلى صفحة تسجيل الدخول
   - يتحقق من صلاحيات المستخدم وفقًا لدوره

3. **تسجيل الخروج**:
   - يقوم بإزالة الرمز من الكوكيز والتخزين المحلي
   - يعيد توجيه المستخدم إلى الصفحة الرئيسية

### 2. إدارة المرضى

1. **إضافة مريض جديد**:

   - يملأ موظف الاستقبال نموذج بيانات المريض
   - يتم إرسال البيانات إلى `/api/patients`
   - يتم إنشاء سجل جديد في جدول `Patient`

2. **عرض وتحرير المرضى**:
   - يمكن البحث عن المرضى والوصول إلى سجلاتهم
   - يمكن تحديث معلومات المريض
   - يتم عرض تاريخ الفحوصات وسجل الفواتير للمريض

### 3. إدارة الفحوصات

1. **تعيين فحص لمريض**:

   - اختيار مريض من قائمة المرضى
   - اختيار فحص أو أكثر من كتالوج الفحوصات
   - إنشاء تعيين فحص جديد (`TestAssignment`)
   - إنشاء فاتورة أو إضافة إلى فاتورة موجودة

2. **تتبع حالة الفحوصات**:
   - تحديث حالة الفحص من خلال عملية سير العمل (انتظار، تم جمع العينة، قيد المعالجة، مكتمل)

### 4. إدارة العينات

1. **جمع العينات**:

   - تسجيل العينة المأخوذة من المريض
   - ربط العينة بتعيين الفحص
   - إنشاء رمز فريد للعينة

2. **تسجيل النتائج**:
   - إدخال نتائج الفحص للعينة
   - تحديث حالة الفحص
   - إرفاق تقرير PDF إذا لزم الأمر

### 5. نظام الفواتير

1. **إنشاء فاتورة**:

   - تُنشأ الفواتير تلقائيًا عند تعيين فحوصات للمريض
   - يمكن إضافة عناصر متعددة للفاتورة

2. **إدارة المدفوعات**:
   - تسجيل المدفوعات المستلمة
   - تتبع المبالغ المدفوعة والمتبقية
   - تحديث حالة الفاتورة (مدفوعة، غير مدفوعة)

### 6. نظام التقارير

1. **إنشاء التقارير**:

   - يمكن للمستخدمين إنشاء تقارير متنوعة (مرضى، فحوصات، مالية)
   - تحديد نطاق التقرير (فترة زمنية، فئة، إلخ)
   - استخراج بيانات من قاعدة البيانات وعرضها بتنسيق مناسب

2. **تصدير التقارير**:
   - إمكانية تصدير التقارير بتنسيق PDF
   - إمكانية مشاركة أو طباعة التقارير

## هيكل المجلدات الرئيسية

### `/src`

المجلد الرئيسي للكود المصدري للمشروع. يحتوي على كافة الملفات البرمجية والمكونات.

```
/src
├── app/            # مكونات الصفحات ومسارات API (Next.js App Router)
├── components/     # مكونات واجهة المستخدم القابلة لإعادة الاستخدام
├── generated/      # ملفات Prisma المولدة آليًا
├── lib/           # مكتبات وأدوات مساعدة
├── types/         # تعريفات TypeScript
└── middleware.ts  # وسيط Next.js للتحقق من المصادقة وإدارة الوصول
```

### `/prisma`

يحتوي على تعريف نموذج قاعدة البيانات وملفات الترحيل.

```
/prisma
├── migrations/    # ملفات ترحيل قاعدة البيانات
└── schema.prisma  # تعريف نموذج قاعدة البيانات
```

### `/public`

يحتوي على الملفات العامة المتاحة مباشرة للمتصفح.

```
/public
├── images/        # الصور المستخدمة في الواجهة
├── next.svg
├── vercel.svg
├── file.svg
├── globe.svg
└── window.svg
```

## تفاصيل المجلدات والملفات

### `/src/app`

يحتوي على صفحات التطبيق باستخدام Next.js App Router. كل مجلد هنا يمثل مسارًا في التطبيق.

```
/src/app
├── (dashboard)/   # مجلد مجمع (grouped layout) للوحة التحكم
├── api/           # نقاط نهاية API
│   ├── auth/      # مسارات المصادقة
│   │   ├── login/
│   │   ├── me/
│   │   └── register/
│   ├── dashboard/
│   ├── invoices/
│   ├── notifications/
│   ├── patients/
│   ├── queue/
│   ├── reports/
│   ├── samples/
│   └── tests/
├── auth/          # صفحات المصادقة (تسجيل الدخول والتسجيل)
├── dashboard/     # صفحات لوحة التحكم
├── invoices/      # صفحات إدارة الفواتير
├── notifications/ # صفحات الإشعارات
├── patients/      # صفحات إدارة المرضى
├── queue/         # صفحات نظام الانتظار
├── reports/       # صفحات التقارير
├── samples/       # صفحات إدارة العينات
├── tests/         # صفحات إدارة الفحوصات
├── globals.css    # أنماط CSS العامة
├── layout.tsx     # التخطيط الرئيسي للتطبيق
├── page.tsx       # الصفحة الرئيسية
└── favicon.ico    # أيقونة الموقع
```

> ملاحظة: المجلد `(dashboard)` بين قوسين لأنه يستخدم ميزة Next.js للمجلدات المجمعة (Route Groups) التي تسمح بتجميع المسارات تحت تخطيط مشترك دون التأثير على هيكل URL. هذا يعني أن المسارات داخل هذا المجلد ستشترك في نفس التخطيط لكن لن يظهر اسم المجلد في عنوان URL.

### `/src/components`

يحتوي على مكونات React القابلة لإعادة الاستخدام في جميع أنحاء التطبيق.

```
/src/components
├── auth/          # مكونات المصادقة مثل نموذج تسجيل الدخول
│   └── AuthContext.tsx # سياق المصادقة الرئيسي لإدارة حالة المستخدم
├── common/        # مكونات مشتركة متعددة الاستخدام
├── invoices/      # مكونات إدارة الفواتير
├── layout/        # مكونات هيكل الصفحة
│   ├── Header.tsx    # شريط التنقل العلوي
│   ├── MainLayout.tsx # التخطيط الرئيسي للصفحات المصادق عليها
│   └── Sidebar.tsx    # الشريط الجانبي مع قائمة التنقل
├── notifications/ # مكونات الإشعارات
├── patients/      # مكونات إدارة المرضى
├── queue/         # مكونات نظام الانتظار
├── reports/       # مكونات التقارير
├── samples/       # مكونات إدارة العينات
├── tests/         # مكونات إدارة الفحوصات
├── ui/            # مكونات واجهة المستخدم الأساسية (أزرار، حقول إدخال، إلخ)
└── LoadingSpinner.tsx # مؤشر التحميل
```

### `/src/lib`

يحتوي على وظائف مساعدة ومكتبات وخدمات تستخدم في جميع أنحاء التطبيق.

```
/src/lib
├── api/           # وظائف مساعدة لطلبات API
├── auth/          # وظائف المصادقة والتفويض
│   ├── AuthContext.tsx # سياق React للمصادقة
│   ├── helpers.ts      # دوال مساعدة للمصادقة
│   ├── jwt.ts          # وظائف إنشاء والتحقق من JWT
│   ├── password.ts     # وظائف تشفير والتحقق من كلمات المرور
│   └── utils.ts        # أدوات مساعدة أخرى للمصادقة
├── prisma/        # إعداد وتكوين Prisma
│   └── index.ts   # تصدير عميل Prisma
├── utils/         # أدوات مساعدة عامة
└── utils.ts       # وظائف مساعدة متنوعة
```

### `/src/types`

يحتوي على تعريفات TypeScript المستخدمة في التطبيق.

```
/src/types
├── api.ts         # أنواع طلبات واستجابات API
└── index.ts       # تعريفات الأنواع الرئيسية للكيانات والنماذج
```

### `/src/middleware.ts`

ملف وسيط Next.js للتحقق من المصادقة والتفويض. يعمل على:

- التحقق من توكن المصادقة
- حماية المسارات المقيدة
- توجيه المستخدمين بناءً على أدوارهم
- التعامل مع مسارات API والصفحات بشكل مناسب

### `/prisma/schema.prisma`

يحدد نموذج قاعدة البيانات ويشمل تعريفات لجميع الكيانات في النظام:

- `User`: المستخدمون (المسؤولون، موظفو الاستقبال، فنيو المختبر، المحاسبون)
- `Patient`: المرضى
- `Test`: كتالوج الفحوصات
- `TestAssignment`: تعيين الفحوصات للمرضى
- `Sample`: عينات الفحص
- `Invoice`: الفواتير
- `InvoiceItem`: عناصر الفاتورة
- `QueueNumber`: أرقام قائمة الانتظار
- `Report`: التقارير

### `/prisma/migrations`

يحتوي على ملفات ترحيل قاعدة البيانات التي تتتبع التغييرات في مخطط قاعدة البيانات بمرور الوقت.

## المكونات الفنية الرئيسية

### نظام المصادقة

- مبني على JWT (JSON Web Tokens)
- يدعم تسجيل الدخول والتسجيل
- التحقق من الوصول المستند إلى الأدوار
- تخزين الجلسة في الكوكيز والتخزين المحلي للمتصفح

### واجهة المستخدم

- مبنية باستخدام React وNext.js
- تصميم متجاوب باستخدام TailwindCSS
- مكونات قابلة لإعادة الاستخدام
- دعم اللغة العربية

### قاعدة البيانات

- MySQL كقاعدة بيانات رئيسية
- Prisma كـ ORM للتعامل مع قاعدة البيانات
- نموذج بيانات قوي مع علاقات واضحة بين الكيانات

### واجهة برمجة التطبيقات (API)

- مسارات API RESTful
- مبنية باستخدام وظائف مسار Next.js
- التعامل مع الأخطاء بشكل صحيح
- التحقق من المدخلات

## المميزات الرئيسية

1. **إدارة المرضى**: تسجيل وحفظ معلومات المرضى وبياناتهم
2. **كتالوج الفحوصات**: إدارة قائمة الفحوصات المتاحة مع الأسعار والتفاصيل
3. **إدارة العينات**: تتبع العينات من التجميع إلى المعالجة
4. **الفواتير والمحاسبة**: إنشاء وإدارة الفواتير والمدفوعات
5. **نظام قائمة الانتظار**: إدارة انتظار المرضى
6. **التقارير**: إنشاء تقارير متنوعة (مرضى، فحوصات، مالية، عينات)
7. **الوصول المستند إلى الأدوار**: أذونات مختلفة حسب دور المستخدم

